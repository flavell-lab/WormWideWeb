export const PLOTLY_COLOR_SCALES = {
  PiYG: [
    [0.0, 'rgb(142,1,82)'],
    [0.1, 'rgb(197,27,125)'],
    [0.2, 'rgb(222,119,174)'],
    [0.3, 'rgb(241,182,218)'],
    [0.4, 'rgb(253,224,239)'],
    [0.5, 'rgb(247,247,247)'],
    [0.6, 'rgb(230,245,208)'],
    [0.7, 'rgb(184,225,134)'],
    [0.8, 'rgb(127,188,65)'],
    [0.9, 'rgb(77,146,33)'],
    [1.0, 'rgb(39,100,25)'],
  ],
  PRGn: [
    [0.0, 'rgb(64,0,75)'],
    [0.1, 'rgb(118,42,131)'],
    [0.2, 'rgb(153,112,171)'],
    [0.3, 'rgb(194,165,207)'],
    [0.4, 'rgb(231,212,232)'],
    [0.5, 'rgb(247,247,247)'],
    [0.6, 'rgb(217,240,211)'],
    [0.7, 'rgb(166,219,160)'],
    [0.8, 'rgb(90,174,97)'],
    [0.9, 'rgb(27,120,55)'],
    [1.0, 'rgb(0,68,27)'],
  ],
  PuOr: [
    [0.0, 'rgb(127,59,8)'],
    [0.1, 'rgb(179,88,6)'],
    [0.2, 'rgb(224,130,20)'],
    [0.3, 'rgb(253,184,99)'],
    [0.4, 'rgb(254,224,182)'],
    [0.5, 'rgb(247,247,247)'],
    [0.6, 'rgb(216,218,235)'],
    [0.7, 'rgb(178,171,210)'],
    [0.8, 'rgb(128,115,172)'],
    [0.9, 'rgb(84,39,136)'],
    [1.0, 'rgb(45,0,75)'],
  ],
  RdYlGn: [
    [0.0, 'rgb(165,0,38)'],
    [0.1, 'rgb(215,48,39)'],
    [0.2, 'rgb(244,109,67)'],
    [0.3, 'rgb(253,174,97)'],
    [0.4, 'rgb(254,224,139)'],
    [0.5, 'rgb(255,255,191)'],
    [0.6, 'rgb(217,239,139)'],
    [0.7, 'rgb(166,217,106)'],
    [0.8, 'rgb(102,189,99)'],
    [0.9, 'rgb(26,152,80)'],
    [1.0, 'rgb(0,104,55)'],
  ],
  Greys: [
    [0, 'rgb(0,0,0)'], [1, 'rgb(255,255,255)']
  ],
  YlGnBu: [
    [0, 'rgb(8,29,88)'], [0.125, 'rgb(37,52,148)'],
    [0.25, 'rgb(34,94,168)'], [0.375, 'rgb(29,145,192)'],
    [0.5, 'rgb(65,182,196)'], [0.625, 'rgb(127,205,187)'],
    [0.75, 'rgb(199,233,180)'], [0.875, 'rgb(237,248,217)'],
    [1, 'rgb(255,255,217)']
  ],
  Greens: [
    [0, 'rgb(0,68,27)'], [0.125, 'rgb(0,109,44)'],
    [0.25, 'rgb(35,139,69)'], [0.375, 'rgb(65,171,93)'],
    [0.5, 'rgb(116,196,118)'], [0.625, 'rgb(161,217,155)'],
    [0.75, 'rgb(199,233,192)'], [0.875, 'rgb(229,245,224)'],
    [1, 'rgb(247,252,245)']
  ],
  YlOrRd: [
    [0, 'rgb(128,0,38)'], [0.125, 'rgb(189,0,38)'],
    [0.25, 'rgb(227,26,28)'], [0.375, 'rgb(252,78,42)'],
    [0.5, 'rgb(253,141,60)'], [0.625, 'rgb(254,178,76)'],
    [0.75, 'rgb(254,217,118)'], [0.875, 'rgb(255,237,160)'],
    [1, 'rgb(255,255,204)']
  ],
  Bluered: [
    [0, 'rgb(0,0,255)'], [1, 'rgb(255,0,0)']
  ],
  RdBu: [
    [0, 'rgb(5,10,172)'], [0.35, 'rgb(106,137,247)'],
    [0.5, 'rgb(190,190,190)'], [0.6, 'rgb(220,170,132)'],
    [0.7, 'rgb(230,145,90)'], [1, 'rgb(178,10,28)']
  ],
  Reds: [
    [0, 'rgb(220,220,220)'], [0.2, 'rgb(245,195,157)'],
    [0.4, 'rgb(245,160,105)'], [1, 'rgb(178,10,28)']
  ],
  Blues: [
    [0, 'rgb(5,10,172)'], [0.35, 'rgb(40,60,190)'],
    [0.5, 'rgb(70,100,245)'], [0.6, 'rgb(90,120,245)'],
    [0.7, 'rgb(106,137,247)'], [1, 'rgb(220,220,220)']
  ],
  Picnic: [
    [0, 'rgb(0,0,255)'], [0.1, 'rgb(51,153,255)'],
    [0.2, 'rgb(102,204,255)'], [0.3, 'rgb(153,204,255)'],
    [0.4, 'rgb(204,204,255)'], [0.5, 'rgb(255,255,255)'],
    [0.6, 'rgb(255,204,255)'], [0.7, 'rgb(255,153,255)'],
    [0.8, 'rgb(255,102,204)'], [0.9, 'rgb(255,102,102)'],
    [1, 'rgb(255,0,0)']
  ],
  Rainbow: [
    [0, 'rgb(150,0,90)'], [0.125, 'rgb(0,0,200)'],
    [0.25, 'rgb(0,25,255)'], [0.375, 'rgb(0,152,255)'],
    [0.5, 'rgb(44,255,150)'], [0.625, 'rgb(151,255,0)'],
    [0.75, 'rgb(255,234,0)'], [0.875, 'rgb(255,111,0)'],
    [1, 'rgb(255,0,0)']
  ],
  Portland: [
    [0, 'rgb(12,51,131)'], [0.25, 'rgb(10,136,186)'],
    [0.5, 'rgb(242,211,56)'], [0.75, 'rgb(242,143,56)'],
    [1, 'rgb(217,30,30)']
  ],
  Jet: [
    [0, 'rgb(0,0,131)'], [0.125, 'rgb(0,60,170)'],
    [0.375, 'rgb(5,255,255)'], [0.625, 'rgb(255,255,0)'],
    [0.875, 'rgb(250,0,0)'], [1, 'rgb(128,0,0)']
  ],
  Hot: [
    [0, 'rgb(0,0,0)'], [0.3, 'rgb(230,0,0)'],
    [0.6, 'rgb(255,210,0)'], [1, 'rgb(255,255,255)']
  ],
  Blackbody: [
    [0, 'rgb(0,0,0)'], [0.2, 'rgb(230,0,0)'],
    [0.4, 'rgb(230,210,0)'], [0.7, 'rgb(255,255,255)'],
    [1, 'rgb(160,200,255)']
  ],
  Earth: [
    [0, 'rgb(0,0,130)'], [0.1, 'rgb(0,180,180)'],
    [0.2, 'rgb(40,210,40)'], [0.4, 'rgb(230,230,50)'],
    [0.6, 'rgb(120,70,20)'], [1, 'rgb(255,255,255)']
  ],
  Electric: [
    [0, 'rgb(0,0,0)'], [0.15, 'rgb(30,0,100)'],
    [0.4, 'rgb(120,0,100)'], [0.6, 'rgb(160,90,0)'],
    [0.8, 'rgb(230,200,0)'], [1, 'rgb(255,250,220)']
  ],
  Viridis: [
    [0, 'rgb(68, 1, 84)'],
    [0.06274509803921569, 'rgb(72, 24, 106)'],
    [0.12549019607843137, 'rgb(71, 45, 123)'],
    [0.18823529411764706, 'rgb(66, 64, 134)'],
    [0.25098039215686274, 'rgb(59, 82, 139)'],
    [0.3137254901960784, 'rgb(51, 99, 141)'],
    [0.3764705882352941, 'rgb(44, 114, 142)'],
    [0.4392156862745098, 'rgb(38, 130, 142)'],
    [0.5019607843137255, 'rgb(33, 145, 140)'],
    [0.5647058823529412, 'rgb(31, 160, 136)'],
    [0.6274509803921569, 'rgb(40, 174, 128)'],
    [0.6901960784313725, 'rgb(63, 188, 115)'],
    [0.7529411764705882, 'rgb(94, 201, 98)'],
    [0.8156862745098039, 'rgb(132, 212, 75)'],
    [0.8784313725490196, 'rgb(173, 220, 48)'],
    [0.9411764705882353, 'rgb(216, 226, 25)'],
    [1, 'rgb(253, 231, 37)']
  ],
  Cividis: [
    [0.000000, 'rgb(0,32,76)'],
    [0.058824, 'rgb(0,42,102)'],
    [0.117647, 'rgb(0,52,110)'],
    [0.176471, 'rgb(39,63,108)'],
    [0.235294, 'rgb(60,74,107)'],
    [0.294118, 'rgb(76,85,107)'],
    [0.352941, 'rgb(91,95,109)'],
    [0.411765, 'rgb(104,106,112)'],
    [0.470588, 'rgb(117,117,117)'],
    [0.529412, 'rgb(131,129,120)'],
    [0.588235, 'rgb(146,140,120)'],
    [0.647059, 'rgb(161,152,118)'],
    [0.705882, 'rgb(176,165,114)'],
    [0.764706, 'rgb(192,177,109)'],
    [0.823529, 'rgb(209,191,102)'],
    [0.882353, 'rgb(225,204,92)'],
    [0.941176, 'rgb(243,219,79)'],
    [1.000000, 'rgb(255,233,69)']
  ]
};

/** 
 * 1) Linear interpolation between two numbers a and b by factor t in [0..1]
 */
function lerp(a, b, t) {
  return a + (b - a) * t;
}

/**
 * 2) Convert a "rgb(r,g,b)" string to [r, g, b]
 */
function rgbStringToArray(rgbStr) {
  // remove "rgb(" and ")" -> e.g. "0,0,255"
  const numbers = rgbStr.substring(4, rgbStr.length - 1).split(',');
  return numbers.map(n => parseInt(n.trim(), 10));
}

/** 
 * 3) Convert a "#RRGGBB" or "#RGB" color to [r, g, b]
 */
function hexToRGBArray(hex) {
  // handle short notation like #ABC
  if (hex.length === 4) {
    hex = '#' + hex[1] + hex[1] + hex[2] + hex[2] + hex[3] + hex[3];
  }
  const num = parseInt(hex.slice(1), 16);
  return [(num >> 16) & 255, (num >> 8) & 255, num & 255];
}

/**
 * 4) General color parsing: either "rgb(...)" or "#..."
 */
function parseColorString(colorStr) {
  if (colorStr.startsWith('#')) {
    // Hex
    return hexToRGBArray(colorStr);
  } else if (colorStr.startsWith('rgb')) {
    // RGB string
    return rgbStringToArray(colorStr);
  }
  // Fallback/other formats? For now, assume black if format not recognized
  console.warn(`Unrecognized color format: ${colorStr}`);
  return [0, 0, 0];
}

/**
 * 5) Interpolate along a color scale array
 *    colorScale is an array of [t_position, colorString] in ascending order of t_position.
 */
export function getInterpolatedColor(colorScale, t) {
  // clamp t to [0..1] or to the colorScaleâ€™s min and max
  const tMin = colorScale[0][0];
  const tMax = colorScale[colorScale.length - 1][0];

  if (t <= tMin) {
    return colorScale[0][1];
  }
  if (t >= tMax) {
    return colorScale[colorScale.length - 1][1];
  }

  // find the interval [i, i+1] where t lies
  for (let i = 0; i < colorScale.length - 1; i++) {
    const t1 = colorScale[i][0];
    const t2 = colorScale[i + 1][0];

    if (t >= t1 && t <= t2) {
      // compute interpolation factor
      const frac = (t - t1) / (t2 - t1);

      // parse the two colors into [r, g, b]
      const c1 = parseColorString(colorScale[i][1]);
      const c2 = parseColorString(colorScale[i + 1][1]);

      // interpolate each channel
      const r = Math.round(lerp(c1[0], c2[0], frac));
      const g = Math.round(lerp(c1[1], c2[1], frac));
      const b = Math.round(lerp(c1[2], c2[2], frac));

      return `rgb(${r}, ${g}, ${b})`;
    }
  }

  // fallback if something goes wrong (should rarely happen)
  return colorScale[colorScale.length - 1][1];
}

export function buildVerticalGradient(colorScale) {
  // For each stop, we create "color XX%"
  const stops = colorScale.map(([t, color]) => {
    const percent = (t * 100).toFixed(1);
    return `${color} ${percent}%`;
  });
  // 'to top' means the 0% is at the bottom, 100% is at the top
  return `linear-gradient(to top, ${stops.join(', ')})`;
}

export function createVerticalColorBar(colorBarId, colorScale) {
  const barEl = document.getElementById(colorBarId);
  const gradientStr = buildVerticalGradient(colorScale);
  barEl.style.background = gradientStr;
}

export function updateColorBar(colorMin, colorMid, colorMax, colorbarId = "colorBar") {
  const colorScale = [
    [0.0, colorMin],
    [0.5, colorMid],
    [1.0, colorMax]
  ];

  createVerticalColorBar(colorbarId, colorScale);
}

export function getNodeColor(value, vmin, vmax, colormapName) {
  const normalized = (value - vmin) / (vmax - vmin)
  const ratio = Math.max(0, Math.min(1, normalized))
  const color = getInterpolatedColor(PLOTLY_COLOR_SCALES[colormapName], ratio);

  return color;
}
